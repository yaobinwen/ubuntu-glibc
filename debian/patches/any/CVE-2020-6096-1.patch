Backport of:

From beea361050728138b82c57dda0c4810402d342b9 Mon Sep 17 00:00:00 2001
From: Alexander Anisimov <a.anisimov@omprussia.ru>
Date: Wed, 8 Jul 2020 14:18:31 +0200
Subject: [PATCH] arm: CVE-2020-6096: Fix multiarch memcpy for negative length
 [BZ #25620]

Unsigned branch instructions could be used for r2 to fix the wrong
behavior when a negative length is passed to memcpy.
This commit fixes the armv7 version.
---
 sysdeps/arm/armv7/multiarch/memcpy_impl.S | 22 +++++++++++-----------
 1 file changed, 11 insertions(+), 11 deletions(-)

--- a/sysdeps/arm/armv7/multiarch/memcpy_impl.S
+++ b/sysdeps/arm/armv7/multiarch/memcpy_impl.S
@@ -299,7 +299,7 @@ ENTRY(memcpy)
 
 	mov	dst, dstin	/* Preserve dstin, we need to return it.  */
 	cmp	count, #64
-	bge	.Lcpy_not_short
+	bhs	.Lcpy_not_short
 	/* Deal with small copies quickly by dropping straight into the
 	   exit block.  */
 
@@ -404,10 +404,10 @@ ENTRY(memcpy)
 
 1:
 	subs	tmp2, count, #64	/* Use tmp2 for count.  */
-	blt	.Ltail63aligned
+	blo	.Ltail63aligned
 
 	cmp	tmp2, #512
-	bge	.Lcpy_body_long
+	bhs	.Lcpy_body_long
 
 .Lcpy_body_medium:			/* Count in tmp2.  */
 #ifdef USE_VFP
@@ -447,7 +447,7 @@ ENTRY(memcpy)
 	sfi_breg dst, \
 	vstr	d1, [\B, #56]
 	add	dst, dst, #64
-	bge	1b
+	bhs	1b
 	tst	tmp2, #0x3f
 	beq	.Ldone
 
@@ -499,7 +499,7 @@ ENTRY(memcpy)
 	sfi_breg dst, \
 	strd	A_l, A_h, [\B, #64]!
 	subs	tmp2, tmp2, #64
-	bge	1b
+	bhs	1b
 	tst	tmp2, #0x3f
 	bne	1f
 	ldr	tmp2,[sp], #FRAME_SIZE
@@ -585,7 +585,7 @@ ENTRY(memcpy)
 	add	src, src, #32
 
 	subs	tmp2, tmp2, #prefetch_lines * 64 * 2
-	blt	2f
+	blo	2f
 1:
 	cpy_line_vfp	d3, 0
 	cpy_line_vfp	d4, 64
@@ -597,7 +597,7 @@ ENTRY(memcpy)
 	add	dst, dst, #2 * 64
 	add	src, src, #2 * 64
 	subs	tmp2, tmp2, #prefetch_lines * 64
-	bge	1b
+	bhs	1b
 
 2:
 	cpy_tail_vfp	d3, 0
@@ -760,8 +760,8 @@ ENTRY(memcpy)
 1:
 	sfi_pld	src, #(3 * 64)
 	subs	count, count, #64
-	ldrmi	tmp2, [sp], #FRAME_SIZE
-	bmi	.Ltail63unaligned
+	ldrlo	tmp2, [sp], #FRAME_SIZE
+	blo	.Ltail63unaligned
 	sfi_pld	src, #(4 * 64)
 
 #ifdef USE_NEON
@@ -786,7 +786,7 @@ ENTRY(memcpy)
 	sfi_breg src, neon_load_multi d0-d3, \B
 	sfi_breg src, neon_load_multi d4-d7, \B
 	subs	count, count, #64
-	bmi	2f
+	blo	2f
 1:
 	sfi_pld	src, #(4 * 64)
 	sfi_breg dst, neon_store_multi d0-d3, \B
@@ -794,7 +794,7 @@ ENTRY(memcpy)
 	sfi_breg dst, neon_store_multi d4-d7, \B
 	sfi_breg src, neon_load_multi d4-d7, \B
 	subs	count, count, #64
-	bpl	1b
+	bhs	1b
 2:
 	sfi_breg dst, neon_store_multi d0-d3, \B
 	sfi_breg dst, neon_store_multi d4-d7, \B
